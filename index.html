<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI画像生成ハンズオン</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 512px;
        margin: 0 auto;
        font-family: Arial, sans-serif;
        padding: 10px;
      }
      textarea,
      button {
        width: 100%;
        font-size: 1em;
        border-radius: 4px;
        border: 1px solid #ccc;
        margin-top: 10px;
      }
      textarea {
        height: 60px;
        padding: 8px;
        resize: none;
      }
      button {
        position: relative;
        padding: 10px;
        background-color: #4caf50;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-bottom: 10px;
      }
      button:disabled {
        background-color: #a5d6a7;
        cursor: not-allowed;
      }
      .spinner {
        margin-left: 8px;
        width: 20px;
        height: 20px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      #image-container {
        width: 100%;
        height: 512px;
        margin-top: 10px;
        border: 1px solid #ccc;
      }
      #generated-image {
        max-width: 100%;
        max-height: 100%;
        display: none;
      }
    </style>
    <script
      src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=_turnstileCb"
      defer
    ></script>
  </head>
  <body>
    <div id="turnstile-widget" style="padding-bottom: 20px"></div>
    <label for="prompt">どんな画像を生成しますか？詳しく教えてください</label>
    <textarea id="prompt" placeholder="例: かわいい猫のイラスト"></textarea>
    <!-- Step2: 翻訳した英語プロンプトで画像生成 -->
    <button id="translate-btn" onclick="translateText()" disabled>
      <span>翻訳</span>
      <div class="spinner" id="translate-spinner"></div>
    </button>
    <label for="translated-prompt">翻訳結果</label>
    <textarea
      id="translated-prompt"
      placeholder="ここに英語の翻訳結果が表示されます"
    ></textarea>
    <button id="generate-btn" onclick="generateImage()" disabled>
      <span>画像生成</span>
      <div class="spinner" id="generate-spinner"></div>
    </button>
    <div id="image-container">
      <img id="generated-image" src="" alt="Generated Image" />
      <p id="error-message" style="color: red; display: none">
        画像生成に失敗しました。もう一度試してください。
      </p>
    </div>

    <script>
      const promptInput = document.getElementById("prompt");
      const translatedPrompt = document.getElementById("translated-prompt");
      const translateBtn = document.getElementById("translate-btn");
      const generateBtn = document.getElementById("generate-btn");
      const translateSpinner = document.getElementById("translate-spinner");
      const generateSpinner = document.getElementById("generate-spinner");
      const img = document.getElementById("generated-image");
      const errorMessage = document.getElementById("error-message");

      function toggleButton(button, spinner, isLoading) {
        button.disabled = isLoading;
        spinner.style.display = isLoading ? "block" : "none";
      }

      function handleError(error) {
        console.error("エラー:", error);
        errorMessage.style.display = "block";
      }

      async function fetchEventStream(url, formData, callback) {
        const response = await fetch(url, {
          method: "POST",
          body: formData,
        });
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");

        let text = "";
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          chunk.split("\n").forEach((line) => {
            line = line.trim();
            if (line.startsWith("data:")) {
              const dataContent = line.slice(5).trim();
              if (dataContent === "[DONE]") return;

              try {
                const jsonData = JSON.parse(dataContent);
                callback(jsonData.response || "");
              } catch (error) {
                console.error("JSON parse error:", error);
              }
            }
          });
        }
      }

      async function translateText() {
        errorMessage.style.display = "none";
        translatedPrompt.value = "翻訳中...";
        toggleButton(translateBtn, translateSpinner, true);
        let translatedText = "";

        try {
          const formData = new FormData();
          formData.set("prompt", promptInput.value);
          await fetchEventStream(`/translate`, formData, (text) => {
            translatedText += text;
            translatedPrompt.value = translatedText;
          });
        } catch (error) {
          handleError(error);
        } finally {
          toggleButton(translateBtn, translateSpinner, false);
        }
      }

      async function generateImage() {
        toggleButton(generateBtn, generateSpinner, true);
        img.style.display = "none";
        errorMessage.style.display = "none";

        try {
          const formData = new FormData();
          // Step1. 日本語プロンプトで画像生成
          // formData.set("prompt", promptInput.value);
          // Step2. 翻訳した英語プロンプトで画像生成
          formData.set("prompt", translatedPrompt.value);

          const response = await fetch(`/generate-image`, {
            method: "POST",
            body: formData,
          });
          if (!response.ok) throw new Error("画像生成エラー");

          const data = await response.json();
          if (data.imageUrl) {
            img.src = data.imageUrl;
            img.style.display = "block";
          } else {
            throw new Error("画像データが取得できませんでした。");
          }
        } catch (error) {
          handleError(error);
        } finally {
          toggleButton(generateBtn, generateSpinner, false);
        }
      }
      function _turnstileCb() {
        turnstile.render("#turnstile-widget", {
          sitekey: "0x4AAAAAAAzs018lIIK5s9-R",
          theme: "light",
          callback: () => {
            translateBtn.disabled = false;
            generateBtn.disabled = false;
          },
          "expired-callback": () => {
            translateBtn.disabled = true;
            generateBtn.disabled = true;
          },
        });
      }
    </script>
  </body>
</html>
