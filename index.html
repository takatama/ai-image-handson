<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI画像生成ハンズオン</title>
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=initializeTurnstile"
      defer
    ></script>
  </head>
  <body>
    <div id="turnstile-widget"></div>
    <div id="main-content">
      <label for="prompt">何をどんな風に描きたいですか？</label>
      <p class="style-hint">
        多彩な表現を楽しもう！ポップアート風、油絵風、水彩画風、報道写真風など
      </p>
      <textarea
        id="prompt"
        placeholder="例: 気持ちよく眠っている猫をポップアート風に"
      ></textarea>
      <button id="translate-btn" onclick="translateText()" disabled>
        <span>英語に翻訳</span>
        <div class="spinner" id="translate-spinner"></div>
      </button>
      <p id="translate-error-message" class="error-message"></p>
      <label for="translated-prompt">翻訳結果</label>
      <textarea
        id="translated-prompt"
        placeholder="ここに英語の翻訳結果が表示されます"
      ></textarea>
      <button id="generate-btn" onclick="generateImage()" disabled>
        <span>画像を生成</span>
        <div class="spinner" id="generate-spinner"></div>
      </button>
      <p id="generate-error-message" class="error-message"></p>
      <div id="image-container">
        <img id="generated-image" src="" alt="Generated Image" />
      </div>
    </div>

    <script>
      const promptInput = document.getElementById("prompt");
      const translatedPrompt = document.getElementById("translated-prompt");
      const translateBtn = document.getElementById("translate-btn");
      const generateBtn = document.getElementById("generate-btn");
      const translateSpinner = document.getElementById("translate-spinner");
      const generateSpinner = document.getElementById("generate-spinner");
      const img = document.getElementById("generated-image");
      const translateErrorMessage = document.getElementById(
        "translate-error-message"
      );
      const generateErrorMessage = document.getElementById(
        "generate-error-message"
      );

      let isAuthenticated = false;

      async function handleTurnstileResponse(token) {
        const formData = new FormData();
        formData.set("cf-turnstile-response", token);
        const response = await fetch("/auth", {
          method: "POST",
          body: formData,
        });
        if (!response.ok) {
          throw new Error("認証に失敗しました");
        }
        isAuthenticated = true;
        translateBtn.disabled = false;
        generateBtn.disabled = false;
      }

      function initializeTurnstile() {
        turnstile.render("#turnstile-widget", {
          // 自分で作成したTurnstileのSite Keyを記入してください
          sitekey: "0x4AAAAAAAzs018lIIK5s9-R",
          callback: handleTurnstileResponse,
          "expired-callback": resetToTurnstile,
        });
      }

      function resetToTurnstile() {
        translateBtn.disabled = true;
        generateBtn.disabled = true;
        isAuthenticated = false;
        turnstile.reset();
      }

      function toggleButton(button, spinner, isLoading) {
        button.disabled = isLoading;
        spinner.style.display = isLoading ? "block" : "none";
      }

      async function handleEventStream(response, textarea) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let text = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          chunk.split("\n").forEach((line) => {
            if (line.startsWith("data: ")) {
              const data = line.replace("data: ", "");
              if (data === "[DONE]") return;
              try {
                const jsonData = JSON.parse(data);
                text += jsonData.response;
                textarea.value = text;
                textarea.scrollTop = textarea.scrollHeight;
              } catch (error) {
                // JSONデータが壊れている場合は無視する
              }
            }
          });
        }
      }

      async function translateText() {
        translateErrorMessage.style.display = "none";
        toggleButton(translateBtn, translateSpinner, true);
        let translatedText = "";

        try {
          const formData = new FormData();
          formData.set("prompt", promptInput.value);
          const response = await fetch(`/translate`, {
            method: "POST",
            body: formData,
            credentials: "include",
          });
          if (!response.ok) {
            if (response.status === 401) {
              translateErrorMessage.textContent =
                "セッションの有効期限が切れました。もう一度試してください。";
              translateErrorMessage.style.display = "block";
              resetToTurnstile();
            } else {
              const errorData = await response.json();
              throw new Error("エラー:", errorData.error);
            }
          }
          await handleEventStream(response, translatedPrompt);
        } catch (error) {
          console.error("エラー: ", error);
          translateErrorMessage.textContent =
            "翻訳に失敗しました。もう一度試してください。";
          translateErrorMessage.style.display = "block";
        } finally {
          toggleButton(translateBtn, translateSpinner, false);
        }
      }

      async function generateImage() {
        toggleButton(generateBtn, generateSpinner, true);
        img.style.display = "none";
        generateErrorMessage.style.display = "none";

        try {
          const formData = new FormData();
          formData.set("prompt", translatedPrompt.value);

          const response = await fetch(`/generate-image`, {
            method: "POST",
            body: formData,
            credentials: "include",
          });

          if (!response.ok) {
            if (response.status === 401) {
              generateErrorMessage.textContent =
                "セッションの有効期限が切れました。もう一度試してください。";
              generateErrorMessage.style.display = "block";
              resetToTurnstile();
            } else {
              throw new Error("画像生成エラー");
            }
          }

          const data = await response.json();
          if (data.imageUrl) {
            img.src = data.imageUrl;
            img.style.display = "block";
          } else {
            throw new Error("画像データが取得できませんでした。");
          }
        } catch (error) {
          console.error("エラー: ", error);
          generateErrorMessage.textContent =
            "画像生成に失敗しました。もう一度試すか、プロンプトを変えてください。";
          generateErrorMessage.style.display = "block";
        } finally {
          toggleButton(generateBtn, generateSpinner, false);
        }
      }
    </script>
  </body>
</html>
